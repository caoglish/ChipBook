{"version":3,"file":"js/266.ee6e7236.js","mappings":"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","sources":["webpack://chipbook/./src/views/HistoryView.vue","webpack://chipbook/./src/views/HistoryView.vue?e071"],"sourcesContent":["<template>\r\n  <div>\r\n    <h2>游戏历史记录</h2>\r\n\t\r\n    <!-- 删除成功的提示消息 -->\r\n    <v-alert\r\n      v-if=\"showDeleteAlert\"\r\n      type=\"success\"\r\n      dismissible\r\n      @input=\"showDeleteAlert = false\"\r\n      class=\"my-4\"\r\n    >\r\n      游戏记录已成功删除。\r\n    </v-alert>\r\n    <v-data-table :headers=\"historyHeaders\" :items=\"games\" class=\"mt-4\">\r\n      <template #item.actions=\"{ item }\">\r\n        <v-btn color=\"primary\" @click=\"viewGame(item.id)\">查看</v-btn>\r\n\t\t   <v-btn color=\"error\" @click=\"confirmDelete(item)\" v-if=\"item.player_count === 0\">删除</v-btn>\r\n      </template>\r\n      <template #item.created_at=\"{ item }\">\r\n        <span>{{item.created_at }}</span>\r\n      </template>\r\n      <template #item.summary=\"{ item }\">\r\n        <span :style=\"{ color: item.summary ? 'green' : 'red'}\">{{ item.summary?\"有\":\"无\" }}</span>\r\n      </template>\r\n    </v-data-table>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { defineComponent } from \"vue\";\r\nimport { collection, getDocs,deleteDoc, doc  } from \"firebase/firestore\";\r\nimport firebaseDb from \"@/Lib/FirebaseDb\";\r\nimport { dateDisplay } from \"@/Lib/DateHelper\";\r\n\r\nconst db = firebaseDb;\r\n\r\nexport default defineComponent({\r\n  name: \"History\",\r\n  data() {\r\n    return {\r\n      games: [], // 所有游戏的列表\r\n\t   showDeleteAlert: false, // 控制删除成功消息的显示状态\r\n      loading: false, // 防止多次触发请求\r\n      historyHeaders: [\r\n        { title: \"游戏ID\", key: \"id\" },\r\n        { title: \"创建时间\", key: \"created_at\" },\r\n        { title: \"玩家数量\", key: \"player_count\" },\r\n        { title: \"每手筹码\", key: \"chips_per_hand\" },\r\n        { title: \"每手金额\", key: \"amount_per_hand\" },\r\n        { title: \"总结\", key: \"summary\" },\r\n        { title: \"操作\", key: \"actions\", sortable: false },\r\n      ],\r\n    };\r\n  },\r\n  methods: {\r\n    async fetchAllGames() {\r\n      if (this.loading) return; // 防止多次请求\r\n      this.loading = true;\r\n\r\n      try {\r\n        const gamesRef = collection(db, \"games\");\r\n        const querySnapshot = await getDocs(gamesRef);\r\n        const gameDataPromises = querySnapshot.docs.map(async (doc) => {\r\n          const data = doc.data();\r\n          console.log(data);\r\n          const gameId = doc.id;\r\n\r\n          // 获取players子集合中的文档数量\r\n          const playersRef = collection(db, `games/${gameId}/players`);\r\n          const playersSnapshot = await getDocs(playersRef);\r\n          const playerCount = playersSnapshot.size; // 子集合中文档的数量\r\n\r\n          return {\r\n            id: gameId,\r\n            created_at: dateDisplay(new Date(data.created_at)),\r\n            sortfield: new Date(data.created_at),\r\n            player_count: playerCount,\r\n            chips_per_hand: data.chips_per_hand,\r\n            amount_per_hand: data.amount_per_hand,\r\n            summary: data.hasOwnProperty(\"summary\") ,\r\n          };\r\n        });\r\n\r\n        // 等待所有Promise完成后排序\r\n        const games = await Promise.all(gameDataPromises);\r\n\r\n        // 按创建时间排序（最新的在前）\r\n        this.games = games.sort((a, b) => b.sortfield - a.sortfield);\r\n      } catch (error) {\r\n        console.error(\"Error fetching all games:\", error);\r\n        alert(\"无法加载游戏历史，请重试。\");\r\n      }finally {\r\n        this.loading = false;\r\n      }\r\n    },\r\n\r\n    viewGame(gameId) {\r\n      // 跳转到GameManagement页面，并传递gameId\r\n      this.$router.push({ name: \"GameManagement\", params: { gameId } });\r\n    },\r\n\t async confirmDelete(game) {\r\n      const confirmation = confirm(`您确定要删除游戏 ${game.id} 吗？此操作不可撤销。`);\r\n      if (confirmation) {\r\n        await this.deleteGame(game.id);\r\n      }\r\n    },\r\n\r\n    async deleteGame(gameId) {\r\n      try {\r\n        const gameRef = doc(db, \"games\", gameId);\r\n        await deleteDoc(gameRef);\r\n        this.games = this.games.filter(game => game.id !== gameId); // 从列表中移除已删除的游戏\r\n         this.showDeleteAlert = true; // 显示删除成功的提示消息\r\n\r\n        // 在 3 秒后自动隐藏提示消息\r\n        setTimeout(() => {\r\n          this.showDeleteAlert = false;\r\n        }, 3000);\r\n      } catch (error) {\r\n        console.error(\"Error deleting game:\", error);\r\n        alert(\"删除游戏记录时出错，请重试。\");\r\n      }\r\n    },\r\n  },\r\n  created() {\r\n    this.fetchAllGames();\r\n  },\r\n});\r\n</script>\r\n\r\n<style scoped>\r\n.v-btn {\r\n  margin: 10px;\r\n}\r\n</style>\r\n","import { render } from \"./HistoryView.vue?vue&type=template&id=5737520c&scoped=true\"\nimport script from \"./HistoryView.vue?vue&type=script&lang=js\"\nexport * from \"./HistoryView.vue?vue&type=script&lang=js\"\n\nimport \"./HistoryView.vue?vue&type=style&index=0&id=5737520c&scoped=true&lang=css\"\n\nimport exportComponent from \"../../node_modules/vue-loader/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['render',render],['__scopeId',\"data-v-5737520c\"]])\n\nexport default __exports__"],"names":["_createElementVNode","_createElementBlock","_hoisted_1","_ctx","showDeleteAlert","_createBlock","_component_v_alert","key","type","dismissible","onInput","_cache","$event","class","default","_withCtx","_createTextVNode","_","_createCommentVNode","_createVNode","_component_v_data_table","headers","historyHeaders","items","games","item","_component_v_btn","color","onClick","viewGame","id","player_count","confirmDelete","_toDisplayString","created_at","style","_normalizeStyle","summary","db","firebaseDb","defineComponent","name","data","loading","title","sortable","methods","fetchAllGames","this","gamesRef","collection","querySnapshot","getDocs","gameDataPromises","docs","map","async","doc","console","log","gameId","playersRef","playersSnapshot","playerCount","size","dateDisplay","Date","sortfield","chips_per_hand","amount_per_hand","hasOwnProperty","Promise","all","sort","a","b","error","alert","$router","push","params","game","confirmation","confirm","deleteGame","gameRef","deleteDoc","filter","setTimeout","created","__exports__","render"],"sourceRoot":""}