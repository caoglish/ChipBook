"use strict";(self["webpackChunkchipbook"]=self["webpackChunkchipbook"]||[]).push([[525],{7525:function(e,a,t){t.r(a),t.d(a,{default:function(){return F}});var l=t(6768),n=t(4232),i=t(554),r=t(2729),s=t(1606),o=t(697),u=t(3745),c=t(6329),d=t(1772),m=t(5608),h=t(5728);const y=e=>((0,l.Qi)("data-v-b6284fae"),e=e(),(0,l.jt)(),e),_=y((()=>(0,l.Lk)("h2",null,"当天的游戏进程",-1))),p={key:0},g=y((()=>(0,l.Lk)("h2",null,"当前局信息",-1))),b=y((()=>(0,l.Lk)("h3",null,"日志记录",-1)));function k(e,a,t,y,k,f){return(0,l.uX)(),(0,l.CE)("div",null,[_,(0,l.bF)(c.Py,{headers:e.gameHeaders,items:e.games,class:"mt-4"},{"item.actions":(0,l.k6)((({item:a})=>[(0,l.bF)(i.D,{onClick:t=>e.selectGame(a)},{default:(0,l.k6)((()=>[(0,l.eW)("继续记录")])),_:2},1032,["onClick"])])),_:1},8,["headers","items"]),(0,l.bF)(i.D,{color:"primary",onClick:e.createNewGame},{default:(0,l.k6)((()=>[(0,l.eW)("创建新德州局")])),_:1},8,["onClick"]),e.currentGame?((0,l.uX)(),(0,l.CE)("div",p,[g,(0,l.Lk)("p",null,"session id: "+(0,n.v_)(e.currentGame.id),1),(0,l.Lk)("p",null,"创建时间: "+(0,n.v_)(e.currentGame.created_at),1),(0,l.Lk)("p",null,"一手筹码数: "+(0,n.v_)(e.currentGame.chips_per_hand),1),(0,l.Lk)("p",null,"每手金额: "+(0,n.v_)(e.currentGame.amount_per_hand),1),(0,l.bF)(i.D,{color:"secondary",onClick:e.openAddPlayersDialog},{default:(0,l.k6)((()=>[(0,l.eW)("加入玩家")])),_:1},8,["onClick"])])):(0,l.Q3)("",!0),(0,l.bF)(c.Py,{headers:e.playerHeaders,items:e.players,class:"mt-4"},{"item.actions":(0,l.k6)((({item:a})=>[(0,l.bF)(i.D,{onClick:t=>e.buyIn(a)},{default:(0,l.k6)((()=>[(0,l.eW)("买入")])),_:2},1032,["onClick"]),(0,l.bF)(i.D,{onClick:t=>e.setRemaining(a)},{default:(0,l.k6)((()=>[(0,l.eW)("剩余")])),_:2},1032,["onClick"]),(0,l.bF)(i.D,{onClick:t=>e.refund(a)},{default:(0,l.k6)((()=>[(0,l.eW)("退码")])),_:2},1032,["onClick"])])),"item.remaining_chips":(0,l.k6)((({item:e})=>[(0,l.Lk)("span",null,(0,n.v_)(null!==e.remaining_chips?e.remaining_chips:"未输入"),1)])),"item.win_loss_chips":(0,l.k6)((({item:e})=>[(0,l.Lk)("span",null,(0,n.v_)(null!==e.remaining_chips?e.win_loss_chips:"未计算"),1)])),"item.win_loss_amount":(0,l.k6)((({item:e})=>[(0,l.Lk)("span",null,(0,n.v_)(null!==e.remaining_chips?e.win_loss_amount:"未计算"),1)])),_:1},8,["headers","items"]),b,(0,l.bF)(i.D,{color:"primary",onClick:e.sortLogsByPlayer},{default:(0,l.k6)((()=>[(0,l.eW)("按玩家排序")])),_:1},8,["onClick"]),(0,l.bF)(i.D,{color:"secondary",onClick:e.sortLogsByTime},{default:(0,l.k6)((()=>[(0,l.eW)("按时间排序")])),_:1},8,["onClick"]),(0,l.bF)(c.Py,{headers:e.logHeaders,items:e.combinedLogs,class:"mt-4"},null,8,["headers","items"]),(0,l.bF)(d.p,{modelValue:e.addPlayersDialog,"onUpdate:modelValue":a[2]||(a[2]=a=>e.addPlayersDialog=a),"max-width":"500px"},{default:(0,l.k6)((()=>[(0,l.bF)(r.J,null,{default:(0,l.k6)((()=>[(0,l.bF)(s.r,null,{default:(0,l.k6)((()=>[(0,l.eW)("选择玩家")])),_:1}),(0,l.bF)(o.O,null,{default:(0,l.k6)((()=>[(0,l.bF)(m.d4,{modelValue:e.selectedPlayers,"onUpdate:modelValue":a[0]||(a[0]=a=>e.selectedPlayers=a),items:e.allPlayers,"item-title":"player_name","item-value":"id",label:"选择一个或多个玩家",chips:"",multiple:""},null,8,["modelValue","items"])])),_:1}),(0,l.bF)(u.S,null,{default:(0,l.k6)((()=>[(0,l.bF)(i.D,{color:"blue darken-1",onClick:e.addPlayersToGame},{default:(0,l.k6)((()=>[(0,l.eW)("添加")])),_:1},8,["onClick"]),(0,l.bF)(i.D,{color:"grey darken-1",onClick:a[1]||(a[1]=a=>e.addPlayersDialog=!1)},{default:(0,l.k6)((()=>[(0,l.eW)("取消")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"]),(0,l.bF)(d.p,{modelValue:e.buyInDialog,"onUpdate:modelValue":a[5]||(a[5]=a=>e.buyInDialog=a),"max-width":"400px"},{default:(0,l.k6)((()=>[(0,l.bF)(r.J,null,{default:(0,l.k6)((()=>[(0,l.bF)(s.r,null,{default:(0,l.k6)((()=>[(0,l.eW)("玩家买入")])),_:1}),(0,l.bF)(o.O,null,{default:(0,l.k6)((()=>[(0,l.bF)(h.W,{modelValue:e.buyInAmount,"onUpdate:modelValue":a[3]||(a[3]=a=>e.buyInAmount=a),label:"买入手数",type:"number"},null,8,["modelValue"])])),_:1}),(0,l.bF)(u.S,null,{default:(0,l.k6)((()=>[(0,l.bF)(i.D,{color:"blue darken-1",onClick:e.confirmBuyIn},{default:(0,l.k6)((()=>[(0,l.eW)("确认")])),_:1},8,["onClick"]),(0,l.bF)(i.D,{color:"grey darken-1",onClick:a[4]||(a[4]=a=>e.buyInDialog=!1)},{default:(0,l.k6)((()=>[(0,l.eW)("取消")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"]),(0,l.bF)(d.p,{modelValue:e.refundDialog,"onUpdate:modelValue":a[8]||(a[8]=a=>e.refundDialog=a),"max-width":"400px"},{default:(0,l.k6)((()=>[(0,l.bF)(r.J,null,{default:(0,l.k6)((()=>[(0,l.bF)(s.r,null,{default:(0,l.k6)((()=>[(0,l.eW)("玩家退码")])),_:1}),(0,l.bF)(o.O,null,{default:(0,l.k6)((()=>[(0,l.bF)(h.W,{modelValue:e.refundAmount,"onUpdate:modelValue":a[6]||(a[6]=a=>e.refundAmount=a),label:"退码手数",type:"number"},null,8,["modelValue"])])),_:1}),(0,l.bF)(u.S,null,{default:(0,l.k6)((()=>[(0,l.bF)(i.D,{color:"blue darken-1",onClick:e.confirmRefund},{default:(0,l.k6)((()=>[(0,l.eW)("确认")])),_:1},8,["onClick"]),(0,l.bF)(i.D,{color:"grey darken-1",onClick:a[7]||(a[7]=a=>e.refundDialog=!1)},{default:(0,l.k6)((()=>[(0,l.eW)("取消")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"]),(0,l.bF)(d.p,{modelValue:e.remainingDialog,"onUpdate:modelValue":a[11]||(a[11]=a=>e.remainingDialog=a),"max-width":"400px"},{default:(0,l.k6)((()=>[(0,l.bF)(r.J,null,{default:(0,l.k6)((()=>[(0,l.bF)(s.r,null,{default:(0,l.k6)((()=>[(0,l.eW)("设置剩余筹码")])),_:1}),(0,l.bF)(o.O,null,{default:(0,l.k6)((()=>[(0,l.bF)(h.W,{modelValue:e.remainingAmount,"onUpdate:modelValue":a[9]||(a[9]=a=>e.remainingAmount=a),label:"剩余筹码数",type:"number"},null,8,["modelValue"])])),_:1}),(0,l.bF)(u.S,null,{default:(0,l.k6)((()=>[(0,l.bF)(i.D,{color:"blue darken-1",onClick:e.confirmRemaining},{default:(0,l.k6)((()=>[(0,l.eW)("确认")])),_:1},8,["onClick"]),(0,l.bF)(i.D,{color:"grey darken-1",onClick:a[10]||(a[10]=a=>e.remainingDialog=!1)},{default:(0,l.k6)((()=>[(0,l.eW)("取消")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"])])}t(4114);var f=t(7617),D=t(8174);const w=D.A;var P=(0,l.pM)({name:"GameManagement",data(){return{games:[],currentGame:null,addPlayersDialog:!1,buyInDialog:!1,refundDialog:!1,remainingDialog:!1,allPlayers:[],selectedPlayers:[],players:[],logs:[],combinedLogs:[],buyInAmount:0,refundAmount:0,remainingAmount:0,currentPlayerId:null,gameHeaders:[{title:"游戏ID",key:"id"},{title:"创建时间",key:"created_at"},{title:"操作",value:"actions",sortable:!1}],playerHeaders:[{title:"固定名称",key:"player_name"},{title:"显示名称",key:"player_display_name"},{title:"买入手数",key:"hands_bought"},{title:"买入筹码",key:"chips_bought"},{title:"买入金额",key:"amount_bought"},{title:"剩余筹码",key:"remaining_chips"},{title:"胜负筹码",key:"win_loss_chips"},{title:"胜负金额",key:"win_loss_amount"},{title:"操作",value:"actions",sortable:!1}],logHeaders:[{title:"时间",key:"date"},{title:"操作类型",key:"action"},{title:"玩家名称",key:"player_display_name"},{title:"详细信息",key:"details"}],sortByPlayer:!0}},methods:{async fetchTodayGames(){try{const e=(new Date).toLocaleDateString(),a=(0,f.rJ)(w,"games"),t=(0,f.P)(a,(0,f._M)("created_at",">=",e)),l=await(0,f.GG)(t);this.games=l.docs.map((e=>({id:e.id,...e.data()})))}catch(e){console.error("Error fetching today's games:",e),alert("无法加载当天的游戏，请重试。")}},async selectGame(e){this.currentGame=e,await this.fetchInGamePlayers(),await this.fetchAllPlayerLogs()},async createNewGame(){try{const e={created_at:(new Date).toLocaleString(),chips_per_hand:500,amount_per_hand:50},a=await(0,f.gS)((0,f.rJ)(w,"games"),e);this.currentGame={id:a.id,...e}}catch(e){console.error("Error creating new game:",e),alert("无法创建新游戏，请重试。")}},openAddPlayersDialog(){this.addPlayersDialog=!0},async addPlayersToGame(){try{this.addPlayersDialog=!1;const e=(0,f.H9)(w,"games",this.currentGame.id);this.players.length;for(const a of this.selectedPlayers){if(this.players.some((e=>e.player_id===a)))continue;const t=this.allPlayers.find((e=>e.id===a)),l=this.players.length+1,n={player_id:a,player_name:t.player_name,player_display_name:t.player_display_name,hands_bought:0,chips_bought:0,amount_bought:0,remaining_chips:null,win_loss_chips:"未计算",win_loss_amount:"未计算",logs:[]};await(0,f.BN)((0,f.H9)(e,"players",`Player_${l}`),n),this.players.push(n)}}catch(e){console.error("Error adding players to game:",e),alert("无法添加玩家，请重试。")}},buyIn(e){this.currentPlayerId=e.player_id,this.buyInDialog=!0},refund(e){this.currentPlayerId=e.player_id,this.refundDialog=!0},setRemaining(e){this.currentPlayerId=e.player_id,this.remainingDialog=!0},async fetchPlayerById(e){try{const a=(0,f.H9)(w,"games",this.currentGame.id),t=(0,f.rJ)(a,"players"),l=(0,f.P)(t,(0,f._M)("player_id","==",e)),n=await(0,f.GG)(l);if(n.empty)return console.log("No player found with the given ID"),null;{const e=n.docs[0];return{id:e.id,data:e.data()}}}catch(a){return console.error("Error fetching player by ID:",a),alert("无法获取玩家信息，请重试。"),null}},async confirmBuyIn(){let e=parseInt(this.buyInAmount,10);if(this.currentPlayerId&&e>0){const t=await this.fetchPlayerById(this.currentPlayerId);if(t){const l=t.data,n=t.id,i=l.hands_bought+e,r=i*this.currentGame.chips_per_hand,s=i*this.currentGame.amount_per_hand,o=null!==l.remaining_chips?this.calculateWinLossChips(r,l.remaining_chips):"未计算";try{const e=(0,f.H9)(w,"games",this.currentGame.id),a=(0,f.H9)((0,f.rJ)(e,"players"),n);await(0,f.mZ)(a,{hands_bought:i,chips_bought:r,amount_bought:s,win_loss_chips:o,win_loss_amount:null!==l.remaining_chips?this.calculateWinLossAmount(o):"未计算",logs:(0,f.hq)({date:(new Date).toLocaleString(),action:"buyin",hands_bought:this.buyInAmount,timestamp:(new Date).toISOString()})}),this.fetchAllPlayerLogs();const t=this.players.find((e=>e.player_id===this.currentPlayerId));t.hands_bought=i,t.chips_bought=r,t.amount_bought=s,t.win_loss_chips=o,t.win_loss_amount=null!==l.remaining_chips?this.calculateWinLossAmount(o):"未计算",this.buyInDialog=!1,this.buyInAmount=0}catch(a){console.error("Error updating buy-in data:",a),alert("买入操作失败，请重试。")}}}},async confirmRefund(){let e=parseInt(this.refundAmount,10);if(this.currentPlayerId&&e>0){const t=await this.fetchPlayerById(this.currentPlayerId);if(t){const l=t.data,n=t.id,i=Math.max(l.hands_bought-e,0);if(i<0)return void alert("退码手数不能超过当前买入手数！");const r=i*this.currentGame.chips_per_hand,s=i*this.currentGame.amount_per_hand,o=null!==l.remaining_chips?this.calculateWinLossChips(r,l.remaining_chips):"未计算";try{const a=(0,f.H9)(w,"games",this.currentGame.id),t=(0,f.H9)((0,f.rJ)(a,"players"),n);await(0,f.mZ)(t,{hands_bought:i,chips_bought:r,amount_bought:s,win_loss_chips:o,win_loss_amount:null!==l.remaining_chips?this.calculateWinLossAmount(o):"未计算",logs:(0,f.hq)({date:(new Date).toLocaleString(),action:"refund",hands_refunded:e,timestamp:(new Date).toISOString()})}),this.fetchAllPlayerLogs();const u=this.players.find((e=>e.player_id===this.currentPlayerId));u.hands_bought=i,u.chips_bought=r,u.amount_bought=s,u.win_loss_chips=o,u.win_loss_amount=null!==l.remaining_chips?this.calculateWinLossAmount(o):"未计算",this.refundDialog=!1,this.refundAmount=0}catch(a){console.error("Error updating refund data:",a),alert("退码操作失败，请重试。")}}}},async confirmRemaining(){let e=parseInt(this.remainingAmount,10);if(this.currentPlayerId&&e>=0){const t=await this.fetchPlayerById(this.currentPlayerId);if(t){const l=t.data,n=t.id,i=this.calculateWinLossChips(l.chips_bought,e);try{const a=(0,f.H9)(w,"games",this.currentGame.id),t=(0,f.H9)((0,f.rJ)(a,"players"),n);await(0,f.mZ)(t,{remaining_chips:e,win_loss_chips:i,win_loss_amount:this.calculateWinLossAmount(i),logs:(0,f.hq)({date:(new Date).toLocaleString(),action:"setRemaining",remaining_chips:e,timestamp:(new Date).toISOString()})}),this.fetchAllPlayerLogs();const l=this.players.find((e=>e.player_id===this.currentPlayerId));l.remaining_chips=e,l.win_loss_chips=i,l.win_loss_amount=this.calculateWinLossAmount(i),this.remainingDialog=!1,this.remainingAmount=0}catch(a){console.error("Error updating remaining chips:",a),alert("更新剩余筹码失败，请重试。")}}}},calculateWinLossChips(e,a){return e-a},calculateWinLossAmount(e){return e*(this.currentGame.amount_per_hand/this.currentGame.chips_per_hand)},async fetchAllPlayerLogs(){try{const e=(0,f.H9)(w,"games",this.currentGame.id),a=await(0,f.GG)((0,f.rJ)(e,"players")),t=a.docs.map((e=>({id:e.id,...e.data()}))),l=t.reduce(((e,a)=>{console.log(e),console.log(a.logs);const t=a.logs.map((e=>({...e,player_display_name:a.player_display_name,player_id:a.player_id,details:{remaining_chips:e.remaining_chips,hands_bought:e.hands_bought,hands_refunded:e.hands_refunded}})));return e.concat(t)}),[]);console.log(l),this.combinedLogs=l,this.sortLogs()}catch(e){console.error("Error fetching all player logs:",e),alert("无法加载所有玩家日志，请重试。")}},sortLogs(){this.sortByPlayer?this.combinedLogs.sort(((e,a)=>e.player_id===a.player_id?new Date(e.timestamp)-new Date(a.timestamp):e.player_id.localeCompare(a.player_id))):this.combinedLogs.sort(((e,a)=>new Date(e.timestamp)-new Date(a.timestamp)))},sortLogsByPlayer(){this.sortByPlayer=!0,this.sortLogs()},sortLogsByTime(){this.sortByPlayer=!1,this.sortLogs()},async fetchPlayers(){try{const e=await(0,f.GG)((0,f.rJ)(w,"players"));this.allPlayers=e.docs.map((e=>({id:e.id,...e.data()})))}catch(e){console.error("Error fetching players:",e),alert("无法加载玩家列表，请重试。")}},async fetchInGamePlayers(){try{const e=(0,f.H9)(w,"games",this.currentGame.id),a=await(0,f.GG)((0,f.rJ)(e,"players"));this.players=a.docs.map((e=>({id:e.id,...e.data()})))}catch(e){console.error("Error fetching in-game players:",e),alert("无法加载当前游戏中的玩家，请重试。")}}},created(){this.fetchTodayGames(),this.fetchPlayers()}}),I=t(1241);const L=(0,I.A)(P,[["render",k],["__scopeId","data-v-b6284fae"]]);var F=L}}]);